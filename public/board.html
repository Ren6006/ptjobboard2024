<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Board</title>
    <style>
      /* Optional styling to arrange the notes */
      #requests-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
      }

      /* Basic styling for the post-it notes */
      .post-it {
        width: 200px; /* Adjust this width as needed */
        background-color: #fdfd96; /* A "post-it" yellow color */
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-shadow: 2px 2px 6px rgba(0,0,0,0.1);
        font-family: Arial, sans-serif;
      }

      .post-it h3 {
        margin: 0 0 5px 0;
        font-size: 18px;
        font-weight: bold;
      }

      .post-it p {
        margin: 5px 0;
        font-size: 14px;
      }

      .post-it strong {
        font-weight: bold;
      }
    /* Simple styling to place the button at the top right */
    .my-account-btn {
        position: absolute;
        top: 20px; 
        right: 20px; 
        background-color: #007BFF; 
        color: #FFFFFF; 
        padding: 10px 20px; 
        text-decoration: none;
        border-radius: 4px;
        font-weight: bold;
        font-family: Arial, sans-serif;
    }

    .my-account-btn:hover {
        background-color: #0056b3;
    }
    </style>
</head>
<body>
    <div id="user-info"></div>
    <div id="requests-container"></div>

    <!-- Include Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <!-- Include Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="common-auth.js"></script>
    <script>
      // Your Firebase configuration (replace with your own keys if different)
      const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "ptjobboard2024.firebaseapp.com",
        databaseURL: "https://ptjobboard2024-default-rtdb.firebaseio.com",
        projectId: "ptjobboard2024",
        storageBucket: "ptjobboard2024.firebasestorage.app",
        messagingSenderId: "401143229772",
        appId: "1:401143229772:web:b5b14d89a89d75443df3e9",
        measurementId: "G-PF9F78SKZV"
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const auth = firebase.auth();

      const userInfoDiv = document.getElementById('user-info');
      const requestsContainer = document.getElementById('requests-container');

      auth.onAuthStateChanged((user) => {
        if (!user) {
          window.location.href = 'signin.html?next=board.html';
          return;
        }
        const email = user.email;
        userInfoDiv.textContent = `Welcome, ${email}!`;

        // Load tutor profile (availability)
        Promise.all([
          db.collection('users').doc(user.uid).get(),
          db.collection('Requests').get()
        ]).then(async ([userSnap, querySnapshot]) => {
          const profile = userSnap.exists ? userSnap.data() : {};
          const availability = profile && profile.availability ? profile.availability : {};

          // Helper: map block label to ID used in availability keys
          function blockLabelToId(label){
            const map = {
              'Block 1':'B1','Block 2':'B2','Block 3':'B3','Block 4':'B4','Block 5':'B5','Block 6':'B6','Block 7':'B7',
              'Lunch':'LUNCH','Lunch ':'LUNCH','DS':'DS','DS/Conference':'DS'
            };
            return map[label] || null;
          }
          // Helper: parse MM/DD/YYYY to YYYY-MM-DD
          function toIso(dateStr){
            if (!dateStr) return null;
            const parts = String(dateStr).split('/');
            if (parts.length !== 3) return null;
            const [mm,dd,yy] = parts;
            const y = yy.length === 4 ? yy : yy; // stored as yyyy already
            return `${y.padStart(4,'0')}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}`;
          }
          async function getCycleDay(iso){
            try {
              const doc = await db.collection('cycleDays').doc(iso).get();
              return doc.exists ? (doc.data().day || null) : null;
            } catch(e){ return null; }
          }

          const cards = [];
          for (const doc of querySnapshot.docs) {
            const data = doc.data();
            const iso = toIso(data.date);
            const cycleDay = iso ? await getCycleDay(iso) : null;
            const blockId = blockLabelToId(data.block || '');
            const availKey = (cycleDay && blockId) ? `D${cycleDay}_${blockId}` : null;
            const isMatch = availKey ? !!availability[availKey] : false;

            // Render note; dim if not a match
            const note = document.createElement('div');
            note.classList.add('post-it');
            if (!isMatch) { note.style.opacity = '0.5'; }

            note.innerHTML = `
        <h3>${data.name || "No Name"}</h3>
        <p><strong>Email:</strong> ${data.email || "N/A"}</p>
        <p><strong>Grade:</strong> ${data.grade || "N/A"}</p>
        <p><strong>Subject:</strong> ${data.subject || "N/A"}</p>
        <p><strong>Class:</strong> ${data.class || "N/A"}</p>
        <p><strong>Topic:</strong> ${data.topic || "N/A"}</p>
        <p><strong>Date:</strong> ${data.date || "N/A"}</p>
        <p><strong>Block:</strong> ${data.block || "N/A"}</p>
        <p><strong>Cycle Day:</strong> ${cycleDay || "?"}</p>
        <p><strong>Location:</strong> ${data.location || "N/A"}</p>
        <p><strong>Info:</strong> ${data.info || "N/A"}</p>
        <p><strong>Match:</strong> ${isMatch ? 'Yes' : 'No'}</p>
      `;

            // Accept flow only if match; otherwise keep hidden
            const acceptButton = document.createElement('button');
            acceptButton.textContent = 'Accept Request';
            if (!isMatch) { acceptButton.disabled = true; acceptButton.title = 'Not in your availability for this cycle day'; }

            const confirmationContainer = document.createElement('div');
            confirmationContainer.style.display = 'none';
            const confirmButton = document.createElement('button');
            confirmButton.textContent = 'âœ“';
            confirmButton.style.marginRight = '10px';
            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'x';
            confirmationContainer.appendChild(confirmButton);
            confirmationContainer.appendChild(cancelButton);

            acceptButton.addEventListener('click', () => {
              acceptButton.style.display = 'none';
              confirmationContainer.style.display = 'inline-block';
            });
            confirmButton.addEventListener('click', () => {
              db.collection("Sessions")
                .add({
                  ...data,
                  cycleDay: cycleDay || null,
                  "tutor email": email
                })
                .then(() => {
                  db.collection("Requests").doc(doc.id).delete()
                    .then(() => { note.remove(); })
                    .catch((error) => { console.error("Error deleting document from Requests:", error); });
                })
                .catch((error) => { console.error("Error adding document to Sessions:", error); });
            });
            cancelButton.addEventListener('click', () => {
              confirmationContainer.style.display = 'none';
              acceptButton.style.display = 'inline-block';
            });

            note.appendChild(acceptButton);
            note.appendChild(confirmationContainer);
            requestsContainer.appendChild(note);
          }
        }).catch((error) => {
          console.error("Error getting documents: ", error);
        });
      });
    </script>
    <script>
        // Example: Suppose you have the user's email from your authentication process
        const userEmail = email;
        
        // Construct the URL with the email as a query parameter
        const accountUrl = "account.html?email=" + encodeURIComponent(userEmail);
    
        // Insert the button into the DOM with the correct URL
        document.write('<a href="' + accountUrl + '" class="my-account-btn">MY ACCOUNT</a>');
    </script>
</body>
</html>
