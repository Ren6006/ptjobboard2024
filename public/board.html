<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Board</title>
  <style>
    :root {
      --bg: #f7f7fb;
      --card: #ffffff;
      --ink: #111827;
      --muted: #6b7280;
      --brand: #1a57d6;
      --brand-dark: #1547ad;
      --ok: #10b981;
      --danger: #ef4444;
      --ring: rgba(26, 87, 214, 0.15);
    }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--ink); }
    a.my-account-btn {
      position: fixed; top: 18px; right: 18px; z-index: 20;
      background: var(--brand); color:#fff; text-decoration:none; padding:10px 16px; border-radius:8px; font-weight:600;
      box-shadow: 0 4px 14px rgba(26,87,214,.25);
    }
    a.my-account-btn:hover { background: var(--brand-dark); }

    .shell { max-width: 1100px; margin: 80px auto 40px; padding: 0 16px; }
    .header { margin-bottom: 16px; }
    .header h1 { margin: 0 0 6px; font-size: 24px; }
    .header p { margin: 0; color: var(--muted); }

    #loading { margin: 16px 0; padding: 12px 16px; background: #fff; border:1px solid #e5e7eb; border-radius: 10px; box-shadow: 0 6px 14px rgba(0,0,0,0.04); }
    .hidden { display:none; }

    /* Full-width banner per request */
    .request-banner {
      width: 100%;
      display: flex;
      align-items: stretch;
      gap: 16px;
      padding: 16px;
      background: var(--card);
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.05);
      margin: 12px 0;
    }
    .req-col {
      display: grid;
      gap: 6px;
    }
    .req-col h3 {
      margin: 0; font-size: 18px;
    }
    .kv { display:flex; gap:8px; flex-wrap: wrap; }
    .kv .k { color: var(--muted); min-width: 72px; }
    .pill {
      display: inline-flex; align-items: center; padding: 4px 8px; border:1px solid #e5e7eb; border-radius: 9999px; background:#fafafa; font-size: 12px;
    }
    .grow { flex: 1 1 auto; }
    .right {
      display: flex; align-items: center; gap: 12px; margin-left: auto;
    }
    select.avail {
      min-width: 260px;
      padding: 10px 12px;
      border: 1px solid #d1d5db; border-radius: 10px; background: #fff;
      outline: none;
    }
    select.avail:focus { box-shadow: 0 0 0 4px var(--ring); border-color: var(--brand); }

    button.primary {
      padding: 10px 14px; border: 0; border-radius: 10px; background: var(--brand); color:#fff; font-weight:600; cursor: pointer;
      box-shadow: 0 6px 14px rgba(26,87,214,0.25);
    }
    button.primary:hover { background: var(--brand-dark); }
    button.ghost {
      padding: 10px 12px; border: 1px solid #e5e7eb; background: #fff; border-radius: 10px; cursor: pointer;
    }

    /* Mobile */
    @media (max-width: 800px) {
      .request-banner { flex-direction: column; }
      .right { justify-content: flex-start; margin-left: 0; }
      select.avail { width: 100%; min-width: 0; }
    }
  </style>
</head>
<body>
  <a id="accountBtn" href="account.html" class="my-account-btn">MY ACCOUNT</a>

  <div class="shell">
    <div class="header">
      <h1>Open Requests</h1>
      <p id="user-info" class="hidden"></p>
    </div>

    <div id="loading">Loading…</div>
    <div id="requests"></div>
  </div>

  <!-- Firebase (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  
    const firebaseConfig = {
      apiKey: "AIzaSyDY2gf5I7kJQ7iXD8F6U2BrEMCYjfnFQxk",
      authDomain: "ptjobboard2024.firebaseapp.com",
      databaseURL: "https://ptjobboard2024-default-rtdb.firebaseio.com",
      projectId: "ptjobboard2024",
      storageBucket: "ptjobboard2024.firebasestorage.app",
      messagingSenderId: "401143229772",
      appId: "1:401143229772:web:b5b14d89a89d75443df3e9",
      measurementId: "G-PF9F78SKZV"
    };
  
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    await setPersistence(auth, browserLocalPersistence).catch(()=>{});
  
    const loadingEl = document.getElementById('loading');
    const userInfoEl = document.getElementById('user-info');
    const listEl = document.getElementById('requests');
  
    const blocksCatalog = {
      '1' : 'Block 1',
      'M11' : 'Junior Seminar',
      '2' : 'Block 2',
      'L' : 'Lunch',
      '3' : 'Block 3',
      'DS': 'DS',
      'CC': 'CC (3:15-4:00)',
      '4': 'Block 4',
      'M10': 'Soph. Seminar',
      '5': 'Block 5',
      '6': 'Block 6',
      '7': 'Block 7',
      'FC': 'Faculty Collaboration',
      'M12': 'Senior Seminar',
      'CT': 'Community Time',
      'OH': 'Office Hours',
    };
  
    const fmtDate = (raw) => {
      try {
        const d = new Date(raw);
        if (!isNaN(d)) return d.toLocaleString([], { dateStyle: 'medium' });
      } catch {}
      return String(raw);
    };
  
    const optionLabel = (slot) => {
      const parts = [];
      if (slot?.date) parts.push(fmtDate(slot.date));
      if (slot?.cycleDay) parts.push(`Day ${slot.cycleDay}`);
      if (slot?.block) {
        const pretty = blocksCatalog[slot.block] || `Block ${slot.block}`;
        parts.push(pretty);
      }
      return parts.join(" • ") || "Unknown slot";
    };
  
    // --- helpers ---
    const slotKey = (slot) => {
      const day = `${slot?.cycleDay ?? ""}`.trim();
      const blk = `${slot?.block ?? ""}`.trim();
      if (!day || !blk) return "";
      return `${day}_${blk}`;
    };
  
    const norm = (s) => (s ?? "")
      .toString()
      .toLowerCase()
      .replace(/\s+/g, " ")
      .trim();
  
    // build a teachable Set from various shapes: array OR map of booleans
    const buildTeachSet = (profile) => {
      const candidates = [
        profile?.classesToTeach,
        profile?.subjectsToTeach,
        profile?.classes,
        profile?.subjects
      ].filter(Boolean);
  
      const items = [];
      for (const c of candidates) {
        if (Array.isArray(c)) {
          items.push(...c);
        } else if (c && typeof c === 'object') {
          items.push(...Object.entries(c).filter(([,v]) => !!v).map(([k]) => k));
        } else if (typeof c === 'string') {
          items.push(c);
        }
      }
      // de-dupe + normalize
      return new Set(items.map(norm).filter(Boolean));
    };
  
    // does the request match the tutor's teachable set?
    // checks both 'class' and 'subject' fields for loose inclusion
    const isTeachable = (req, teachSet) => {
      if (!teachSet || teachSet.size === 0) return true; // if no teach list on profile, don't block
      const reqClass = norm(req.class);
      const reqSubject = norm(req.subject);
      for (const t of teachSet) {
        if (!t) continue;
        // accept if either side includes the other (handles "AP Calc AB" vs "Calculus")
        if (t == reqClass) {
          return true;
        }
      }
      return false;
    };
  
    const renderRequest = (docId, data, tutor, matchingSlots) => {
      const wrap = document.createElement('div');
      wrap.className = 'request-banner';
  
      const left = document.createElement('div');
      left.className = 'req-col grow';
      left.innerHTML = `
        <h3>${data.name || 'No Name'} <span class="pill">${data.subject || '—'}</span> <span class="pill">${data.class || '—'}</span></h3>
        <div class="kv"><span class="k">Email</span><span>${data.email || 'N/A'}</span></div>
        <div class="kv"><span class="k">Grade</span><span>${data.grade || 'N/A'}</span></div>
        <div class="kv"><span class="k">Topic</span><span>${data.topic || 'N/A'}</span></div>
        <div class="kv"><span class="k">Location</span><span>${data.location || 'N/A'}</span></div>
        <div class="kv"><span class="k">Info</span><span>${data.info || '—'}</span></div>
      `;
  
      const right = document.createElement('div');
      right.className = 'right';
  
      const select = document.createElement('select');
      select.className = 'avail';
      select.ariaLabel = 'Choose availability slot';
  
      const ph = document.createElement('option');
      ph.value = '';
      ph.disabled = true;
      ph.selected = true;
      ph.textContent = matchingSlots.length ? 'Select an availability…' : 'No matching availability';
      select.appendChild(ph);
  
      matchingSlots.forEach((slot, idx) => {
        const opt = document.createElement('option');
        opt.value = String(idx);
        opt.textContent = optionLabel(slot);
        select.appendChild(opt);
      });
  
      const finalizeBtn = document.createElement('button');
      finalizeBtn.className = 'primary';
      finalizeBtn.textContent = 'Finalize';
      finalizeBtn.disabled = matchingSlots.length === 0;
  
      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'ghost';
      cancelBtn.textContent = 'Dismiss';
  
      right.appendChild(select);
      right.appendChild(finalizeBtn);
      right.appendChild(cancelBtn);
  
      cancelBtn.addEventListener('click', () => {
        select.selectedIndex = 0;
      });
  
      finalizeBtn.addEventListener('click', async () => {
        const chosen = select.value;
        if (!chosen) {
          select.focus();
          select.reportValidity?.();
          return;
        }
        const i = parseInt(chosen, 10);
        const chosenSlot = matchingSlots[i] || {};
  
        finalizeBtn.disabled = true;
  
        try {
          await addDoc(collection(db, 'Sessions'), {
            requestId: docId,
            name: data.name || null,
            email: data.email || null,
            grade: data.grade || null,
            subject: data.subject || null,
            class: data.class || null,
            topic: data.topic || null,
            location: data.location || null,
            info: data.info || null,
            slot: {
              date: chosenSlot.date || null,
              cycleDay: chosenSlot.cycleDay || null,
              block: chosenSlot.block || null
            },
            tutorUid: tutor.uid,
            tutorEmail: tutor.email || null,
            tutorName: tutor.displayName || null,
            createdAt: new Date().toISOString(),
            status: 'scheduled'
          });
  
          await deleteDoc(doc(db, 'Requests', docId));
          wrap.remove();
        } catch (err) {
          console.error('Finalize error:', err);
          finalizeBtn.disabled = false;
        }
      });
  
      wrap.appendChild(left);
      wrap.appendChild(right);
      return wrap;
    };
  
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'signup.html';
        return;
      }
      userInfoEl.textContent = `Signed in as ${user.displayName || user.email || 'Tutor'}`;
      userInfoEl.classList.remove('hidden');
  
      try {
        // --- load tutor profile ---
        const userRef = doc(db, 'users', user.uid);
        const userSnap = await getDoc(userRef);
        const profile = userSnap.exists() ? (userSnap.data() || {}) : {};
  
        // availability map -> Set of "cycleDay_block"
        const availMap = profile.availability || {};
        const myAvailSet = new Set(
          Object.entries(availMap)
            .filter(([, v]) => !!v)
            .map(([k]) => k.trim())
        );
  
        // teachable set
        const teachSet = buildTeachSet(profile);
  
        // --- load requests ---
        const snap = await getDocs(collection(db, 'Requests'));
        loadingEl.classList.add('hidden');
  
        if (snap.empty) {
          const none = document.createElement('div');
          none.id = 'empty';
          none.textContent = 'No open requests.';
          listEl.appendChild(none);
          return;
        }
  
        let renderedCount = 0;
  
        snap.forEach((d) => {
          const data = d.data() || {};
  
          // normalize request slots
          let slots = [];
          if (Array.isArray(data.availability)) {
            slots = data.availability;
          } else if (data.availability && typeof data.availability === 'object') {
            slots = Object.values(data.availability);
          }
  
          // filter by availability match
          const matchingSlots = slots.filter((s) => {
            const key = slotKey(s);
            return key && myAvailSet.has(key);
          });
  
          // filter by teachable class/subject
          const teachOK = isTeachable(data, teachSet);
  
          // render only if BOTH conditions pass
          if (matchingSlots.length > 0 && teachOK) {
            const banner = renderRequest(d.id, data, user, matchingSlots);
            listEl.appendChild(banner);
            renderedCount++;
          }
        });
  
        if (renderedCount === 0) {
          const none = document.createElement('div');
          none.id = 'empty';
          none.textContent = 'No open requests that match your availability and classes to teach.';
          listEl.appendChild(none);
        }
      } catch (e) {
        loadingEl.textContent = 'Failed to load requests.';
        console.error(e);
      }
    });
  </script>
  
  
</body>
</html>
