<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Board</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <script src="common-auth.js"></script>
    <script src="firebase-config.js"></script>
    <style>
      :root {
        --bg: #f7f7fb;
        --card: #ffffff;
        --ink: #111827;
        --muted: #6b7280;
        --brand: #1a57d6;
        --brand-dark: #1547ad;
        --ok: #10b981;
        --danger: #ef4444;
        --ring: rgba(26, 87, 214, 0.15);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: var(--bg);
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial,
          sans-serif;
        color: var(--ink);
      }
      a.my-account-btn {
        background: var(--brand);
        color: #fff;
        text-decoration: none;
        padding: 10px 16px;
        border-radius: 8px;
        font-weight: 600;
      }
      a.my-account-btn:hover {
        background: var(--brand-dark);
      }
      

      button.signout-btn {
        background: var(--danger);
        color: #fff;
        padding: 10px 16px;
        border: 0;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
      }
      button.signout-btn:hover { opacity: 0.9; }

      .top-actions {
        position: fixed;
        top: 18px;
        right: 18px;
        z-index: 20;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .top-actions .top-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 10px 16px;
        min-height: 40px;
        line-height: 20px;
        font-size: 14px;
        border-radius: 8px;
        font-weight: 600;
        border: 0;
        text-decoration: none;
      }

      .shell {
        max-width: 1100px;
        margin: 80px auto 40px;
        padding: 0 16px;
      }
      .header {
        margin-bottom: 16px;
      }
      .header h1 {
        margin: 0 0 6px;
        font-size: 24px;
      }
      .header p {
        margin: 0;
        color: var(--muted);
      }

      #loading {
        margin: 16px 0;
        padding: 12px 16px;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.04);
      }
      .hidden {
        display: none;
      }

      /* Full-width banner per request */
      .request-banner {
        width: 100%;
        display: flex;
        align-items: stretch;
        gap: 16px;
        padding: 16px;
        background: var(--card);
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.05);
        margin: 12px 0;
      }
      .req-col {
        display: grid;
        gap: 6px;
      }
      .req-col h3 {
        margin: 0;
        font-size: 18px;
      }
      .kv {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .kv .k {
        color: var(--muted);
        min-width: 72px;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        padding: 4px 8px;
        border: 1px solid #e5e7eb;
        border-radius: 9999px;
        background: #fafafa;
        font-size: 12px;
      }
      .grow {
        flex: 1 1 auto;
      }
      .right {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-left: auto;
      }
      select.avail {
        min-width: 260px;
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 10px;
        background: #fff;
        outline: none;
      }
      select.avail:focus {
        box-shadow: 0 0 0 4px var(--ring);
        border-color: var(--brand);
      }

      button.primary {
        padding: 10px 14px;
        border: 0;
        border-radius: 10px;
        background: var(--brand);
        color: #fff;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      button.primary:hover {
        background: var(--brand-dark);
      }
      button.ghost {
        padding: 10px 12px;
        border: 1px solid #e5e7eb;
        background: #fff;
        border-radius: 10px;
        cursor: pointer;
      }

      /* Mobile */
      @media (max-width: 800px) {
        .request-banner {
          flex-direction: column;
        }
        .right {
          justify-content: flex-start;
          margin-left: 0;
        }
        select.avail {
          width: 100%;
          min-width: 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="top-actions">
      <a id="accountBtn" href="account.html" class="my-account-btn top-btn">MY ACCOUNT</a>
      <button id="signOutBtn" class="signout-btn top-btn">SIGN OUT</button>
    </div>

    <div id="topBanner" class="hidden" style="max-width:1100px;margin:80px auto 12px;padding:10px 12px;border-radius:8px;border:1px solid #fecaca;background:#fee2e2;color:#b91c1c;font-weight:600"></div>

    <div class="shell">
      <!-- NEW: Upcoming Sessions -->
      <div class="header" style="margin-bottom: 6px">
        <h1>My Upcoming Sessions</h1>
        <p id="user-info" class="hidden"></p>
      </div>

      <div id="sessions-loading" class="hidden">Loading sessionsâ€¦</div>
      <div id="sessions"></div>

      <!-- Existing: Open Requests -->
      <div class="header" style="margin-top: 24px">
        <h1>Open Requests</h1>
      </div>

      <div id="loading">Loadingâ€¦</div>
      <div id="requests"></div>

      <!-- NEW: Completed Sessions -->
      <div class="header" style="margin-top: 24px">
        <h1>My Completed Sessions</h1>
      </div>
      <div id="completed-loading" class="hidden">Loading sessionsâ€¦</div>
      <div id="completed"></div>

      <!-- NEW: Self-Report Hours -->
      <div class="header" style="margin-top: 24px">
        <h1>Self-Report Hours</h1>
        <p style="color: var(--muted)">Add tutoring hours that weren't tracked automatically.</p>
      </div>
      <div style="background: var(--card); border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin: 12px 0;">
        <button id="addHourBtn" class="primary">+ Add Hour</button>
      </div>

      <!-- NEW: My Hours Breakdown -->
      <div class="header" style="margin-top: 24px">
        <h1>My Hours</h1>
      </div>
      <div id="hours-loading" class="hidden">Loading hoursâ€¦</div>
      <div id="hours"></div>

      <!-- Subject Lead / Head Console (conditional) -->
      <div id="lead-console" class="hidden">
        <div class="header" style="margin-top: 24px">
          <h1>Lead Console</h1>
          <p class="muted">Visible to subject leads and heads.</p>
        </div>

        <div class="header" style="margin-top: 8px">
          <h1>Pending Class Approvals</h1>
        </div>
        <div id="lead-approvals-loading" class="hidden">Loading approvalsâ€¦</div>
        <div id="lead-approvals"></div>

        <div class="header" style="margin-top: 24px">
          <h1>Open Tutoring Requests in My Subjects</h1>
        </div>
        <div id="lead-open-loading" class="hidden">Loading requestsâ€¦</div>
        <div id="lead-open"></div>

        <div class="header" style="margin-top: 24px">
          <h1>Completed Sessions in My Subjects</h1>
        </div>
        <div id="lead-completed-loading" class="hidden">Loading sessionsâ€¦</div>
        <div id="lead-completed"></div>
      </div>
    </div>

    <!-- Add Hour Modal -->
    <div id="addHourModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:100; align-items:center; justify-content:center; padding:20px;">
      <div style="width:min(600px, 96vw); background:#fff; border-radius:14px; overflow:hidden; box-shadow:0 20px 60px rgba(0,0,0,0.2);">
        <div style="padding:14px 16px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between;">
          <h3 style="margin:0; font-size:1.05rem;">Add Hour</h3>
          <button id="closeHourModal" style="border:0; background:transparent; font-size:24px; cursor:pointer; padding:0 8px;">Ã—</button>
        </div>
        <div style="padding:16px;">
          <div style="display:grid; gap:12px;">
            <div>
              <label style="display:block; font-size:12px; color:#5b667a; margin-bottom:6px;">Date</label>
              <div style="display:flex; align-items:center; gap:10px;">
                <input type="date" id="hourDate" style="position:absolute; width:1px; height:1px; margin:-1px; padding:0; border:0; clip:rect(0 0 0 0); overflow:hidden;" />
                <button type="button" id="hourCalendarBtn" style="display:inline-flex; align-items:center; justify-content:center; width:64px; height:64px; border:2px solid #cbd5e1; border-radius:12px; background:#fff; cursor:pointer; font-size:28px;">ðŸ“…</button>
                <span id="hourCalendarLabel" style="font-size:14px; color:#334155;">Pick a date</span>
              </div>
              <div id="hourDayLabel" style="margin-top:6px; color:#94a3b8; font-size:13px;"></div>
            </div>
            <div>
              <label style="display:block; font-size:12px; color:#5b667a; margin-bottom:6px;">Block/Period</label>
              <div id="hourScheduleWrap" style="border:1px solid #e5e7ef; border-radius:10px; overflow:hidden; min-height:60px; display:flex; align-items:center; justify-content:center; color:#64748b;">
                Pick a date to load the scheduleâ€¦
              </div>
            </div>
            <div>
              <label style="display:block; font-size:12px; color:#5b667a; margin-bottom:6px;">Description (optional)</label>
              <input type="text" id="hourDescription" placeholder="e.g., Helped with calculus homework" style="width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:10px; background:#fff; outline:none;" />
            </div>
          </div>
          <div style="margin-top:16px; display:flex; gap:8px; justify-content:flex-end;">
            <button id="cancelHourBtn" class="ghost">Cancel</button>
            <button id="submitHourBtn" class="primary">Add Hour</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Firebase (modular) -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        setPersistence,
        browserLocalPersistence,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import {
        getFirestore,
        collection,
        getDocs,
        addDoc,
        deleteDoc,
        doc,
        getDoc,
        setDoc,
        query,
        where,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      const app = initializeApp(window.__FIREBASE_CONFIG__);
      const auth = getAuth(app);
      const db = getFirestore(app);
      await setPersistence(auth, browserLocalPersistence).catch(() => {});

      const loadingEl = document.getElementById("loading");
      const sessionsLoadingEl = document.getElementById("sessions-loading");
      const userInfoEl = document.getElementById("user-info");
      const listEl = document.getElementById("requests");
      const sessionsEl = document.getElementById("sessions");
      const completedLoadingEl = document.getElementById("completed-loading");
      const completedEl = document.getElementById("completed");
      const signOutBtn = document.getElementById("signOutBtn");
      const topBanner = document.getElementById("topBanner");
      const leadConsole = document.getElementById("lead-console");
      const leadApprovalsEl = document.getElementById("lead-approvals");
      const leadApprovalsLoadingEl = document.getElementById("lead-approvals-loading");
      const leadOpenEl = document.getElementById("lead-open");
      const leadOpenLoadingEl = document.getElementById("lead-open-loading");
      const leadCompletedEl = document.getElementById("lead-completed");
      const leadCompletedLoadingEl = document.getElementById("lead-completed-loading");

      const blocksCatalog = {
        1: "Block 1",
        M11: "Junior Seminar",
        2: "Block 2",
        L: "Lunch",
        3: "Block 3",
        DS: "DS",
        CC: "CC (3:15-4:00)",
        4: "Block 4",
        M10: "Soph. Seminar",
        5: "Block 5",
        6: "Block 6",
        7: "Block 7",
        FC: "Faculty Collaboration",
        M12: "Senior Seminar",
        CT: "Community Time",
        OH: "Office Hours",
      };

      const fmtDate = (raw) => {
        try {
          const d = new Date(raw);
          if (!isNaN(d)) return d.toLocaleString([], { dateStyle: "medium" });
        } catch {}
        return String(raw);
      };

      const optionLabel = (slot) => {
        const parts = [];
        if (slot?.date) parts.push(fmtDate(slot.date));
        if (slot?.cycleDay) parts.push(`Day ${slot.cycleDay}`);
        if (slot?.block) {
          const pretty = blocksCatalog[slot.block] || `Block ${slot.block}`;
          parts.push(pretty);
        }
        return parts.join(" â€¢ ") || "Unknown slot";
      };

      // --- helpers ---
      const slotKey = (slot) => {
        const day = `${slot?.cycleDay ?? ""}`.trim();
        const blk = `${slot?.block ?? ""}`.trim();
        if (!day || !blk) return "";
        return `${day}_${blk}`;
      };

      const norm = (s) =>
        (s ?? "").toString().toLowerCase().replace(/\s+/g, " ").trim();

      // build a teachable Set from various shapes: array OR map of booleans
      const buildTeachSet = (profile) => {
        const candidates = [
          profile?.classesToTeach,
          profile?.subjectsToTeach,
          profile?.classes,
          profile?.subjects,
        ].filter(Boolean);

        const items = [];
        for (const c of candidates) {
          if (Array.isArray(c)) {
            items.push(...c);
          } else if (c && typeof c === "object") {
            items.push(
              ...Object.entries(c)
                .filter(([, v]) => !!v)
                .map(([k]) => k)
            );
          } else if (typeof c === "string") {
            items.push(c);
          }
        }
        return new Set(items.map(norm).filter(Boolean));
      };

      const isTeachable = (req, teachSet) => {
        if (!teachSet || teachSet.size === 0) return true;
        const reqClass = norm(req.class);
        const reqSubject = norm(req.subject);
        for (const t of teachSet) {
          if (!t) continue;
          if (reqClass == t || reqClass == "other") {
            return true;
          }
        }
        return false;
      };

      const renderRequest = (docId, data, tutor, matchingSlots) => {
        const wrap = document.createElement("div");
        wrap.className = "request-banner";

        const left = document.createElement("div");
        left.className = "req-col grow";
        left.innerHTML = `
        <h3>${data.name || "No Name"} <span class="pill">${
          data.subject || "â€”"
        }</span> <span class="pill">${data.class || "â€”"}</span></h3>
        <div class="kv"><span class="k">Email</span><span>${
          data.email || "N/A"
        }</span></div>
        <div class="kv"><span class="k">Grade</span><span>${
          data.grade || "N/A"
        }</span></div>
        <div class="kv"><span class="k">Topic</span><span>${
          data.topic || "N/A"
        }</span></div>
        <div class="kv"><span class="k">Location</span><span>${
          data.location || "N/A"
        }</span></div>
        <div class="kv"><span class="k">Info</span><span>${
          data.info || "â€”"
        }</span></div>
      `;

        const right = document.createElement("div");
        right.className = "right";

        const select = document.createElement("select");
        select.className = "avail";
        select.ariaLabel = "Choose availability slot";

        const ph = document.createElement("option");
        ph.value = "";
        ph.disabled = true;
        ph.selected = true;
        ph.textContent = matchingSlots.length
          ? "Select an availabilityâ€¦"
          : "No matching availability";
        select.appendChild(ph);

        matchingSlots.forEach((slot, idx) => {
          const opt = document.createElement("option");
          opt.value = String(idx);
          opt.textContent = optionLabel(slot);
          select.appendChild(opt);
        });

        const finalizeBtn = document.createElement("button");
        finalizeBtn.className = "primary";
        finalizeBtn.textContent = "Finalize";
        finalizeBtn.disabled = matchingSlots.length === 0;

        const cancelBtn = document.createElement("button");
        cancelBtn.className = "ghost";
        cancelBtn.textContent = "Dismiss";

        right.appendChild(select);
        right.appendChild(finalizeBtn);
        right.appendChild(cancelBtn);

        cancelBtn.addEventListener("click", () => {
          select.selectedIndex = 0;
        });

        finalizeBtn.addEventListener("click", async () => {
          const chosen = select.value;
          if (!chosen) {
            select.focus();
            select.reportValidity?.();
            return;
          }
          const i = parseInt(chosen, 10);
          const chosenSlot = matchingSlots[i] || {};

          finalizeBtn.disabled = true;

          try {
            await addDoc(collection(db, "Sessions"), {
              requestId: docId,
              name: data.name || null,
              email: data.email || null,
              grade: data.grade || null,
              subject: data.subject || null,
              class: data.class || null,
              topic: data.topic || null,
              location: data.location || null,
              info: data.info || null,
              slot: {
                date: chosenSlot.date || null,
                cycleDay: chosenSlot.cycleDay || null,
                block: chosenSlot.block || null,
              },
              availability: data.availability,
              tutorUid: tutor.uid,
              tutorEmail: tutor.email || null,
              tutorName: tutor.displayName || null,
              createdAt: new Date().toISOString(),
              status: "scheduled",
            });

            await deleteDoc(doc(db, "Requests", docId));
            await loadSessions(tutor);
            wrap.remove();
          } catch (err) {
            console.error("Finalize error:", err);
            finalizeBtn.disabled = false;
          }
        });

        wrap.appendChild(left);
        wrap.appendChild(right);
        return wrap;
      };

      // --- Sessions renderer (uses same banner layout for consistency) ---
      const renderSession = (s, opts = {}) => {
        const { showCancel = false, showComplete = false, currentUser = null } = opts;
        const wrap = document.createElement("div");
        wrap.className = "request-banner";

        const left = document.createElement("div");
        left.className = "req-col grow";
        const slot = s.slot || {};
        left.innerHTML = `
        <h3>${s.name || "Student"} <span class="pill">${
          s.subject || "â€”"
        }</span> <span class="pill">${s.class || "â€”"}</span></h3>
        <div class="kv"><span class="k">Date</span><span>${optionLabel(
          slot
        )}</span></div>
        <div class="kv"><span class="k">Location</span><span>${
          s.location || "N/A"
        }</span></div>
        <div class="kv"><span class="k">Status</span><span class="pill">${
          s.status || "scheduled"
        }</span></div>
      `;

        wrap.appendChild(left);
        if (showCancel || showComplete) {
          const right = document.createElement("div");
          right.className = "right";
          
          // Commented out manual completion - sessions now auto-complete after their date passes
          /*
          if (showComplete && s.status === "scheduled") {
            const completeBtn = document.createElement("button");
            completeBtn.className = "primary";
            completeBtn.textContent = "Mark Completed";
            completeBtn.addEventListener("click", async () => {
              if (!confirm("Mark this session as completed? This will add 1 hour to your total.")) return;
              completeBtn.disabled = true;
              try {
                await setDoc(doc(db, "Sessions", s.id), { status: "completed" }, { merge: true });
                alert("Session marked as completed! An hour has been added to your total.");
                window.location.reload();
              } catch (err) {
                console.error("Error marking session as completed:", err);
                alert("Failed to mark session as completed. Please try again.");
                completeBtn.disabled = false;
              }
            });
            right.appendChild(completeBtn);
          }
          */
          
          if (showCancel) {
            const cancelBtn = document.createElement("button");
            cancelBtn.className = "ghost";
            cancelBtn.textContent = "Cancel & Reopen";

            cancelBtn.addEventListener("click", async () => {
              cancelBtn.disabled = true;
              try {
                // Prefer original availability; fall back to normalized; last resort: chosen slot only
                const availability = s.availability ?? (s.slot ? [s.slot] : []);

                const reqData = {
                  name: s.name ?? null,
                  email: s.email ?? null,
                  grade: s.grade ?? null,
                  subject: s.subject ?? null,
                  class: s.class ?? null,
                  topic: s.topic ?? null,
                  location: s.location ?? null,
                  info: s.info ?? null,
                  availability,
                };
                // If we know the original requestId, restore into the same doc ID.
                if (s.requestId) {
                  await setDoc(doc(db, "Requests", s.requestId), reqData);
                } else {
                  await addDoc(collection(db, "Requests"), reqData);
                }

                // Remove the session
                await deleteDoc(doc(db, "Sessions", s.id));

                // Quick, reliable UI refresh (rebuilds Upcoming, Open, Completed)
                window.location.reload();
              } catch (err) {
                console.error("Cancel & Reopen error:", err);
                cancelBtn.disabled = false;
                alert("Failed to cancel the session. Please try again.");
              }
            });

            right.appendChild(cancelBtn);
          }
          
          wrap.appendChild(right);
        }
        return wrap;
      };

      // --- NEW: reusable loader for "My Completed Sessions" (yesterday or earlier) ---
      async function loadCompletedSessions(currentUser) {
        completedLoadingEl.classList.remove("hidden");
        completedEl.innerHTML = ""; // clear

        // match by tutorName as requested (same as upcoming)
        const myName = currentUser.displayName || "";
        const qSessions = query(
          collection(db, "Sessions"),
          where("tutorName", "==", myName)
        );
        const sessSnap = await getDocs(qSessions);

        const today = todayStart();
        const completed = [];

        sessSnap.forEach((d) => {
          const s = d.data() || {};
          const dateObj = toDate(s.slot?.date);
          if (!dateObj) return;
          // keep strictly before today (yesterday or earlier)
          if (dateObj < today) {
            completed.push({ id: d.id, ...s, _dateObj: dateObj });
          }
        });

        // sort ascending by date (same behavior as upcoming)
        completed.sort((a, b) => {
          const d = a._dateObj - b._dateObj;
          if (d !== 0) return d;
          const ac = (a.slot?.cycleDay ?? "")
            .toString()
            .localeCompare((b.slot?.cycleDay ?? "").toString());
          if (ac !== 0) return ac;
          return (a.slot?.block ?? "")
            .toString()
            .localeCompare((b.slot?.block ?? "").toString());
        });

        completedLoadingEl.classList.add("hidden");

        if (completed.length === 0) {
          const none = document.createElement("div");
          none.id = "completed-empty";
          none.textContent = "No completed sessions.";
          completedEl.appendChild(none);
        } else {
          completed.forEach((s) => completedEl.appendChild(renderSession(s)));
        }
      }

      // --- NEW: reusable loader for "My Upcoming Sessions" ---
      const toDate = (raw) => {
        if (!raw) return null;
        if (raw instanceof Date) return isNaN(raw) ? null : raw;
        let d = new Date(raw);
        if (!isNaN(d)) return d;
        const m = String(raw).match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
        if (m) {
          const [, mm, dd, yyyy] = m.map(Number);
          d = new Date(yyyy, mm - 1, dd);
          if (!isNaN(d)) return d;
        }
        return null;
      };
      const todayStart = () => {
        const d = new Date();
        d.setHours(0, 0, 0, 0);
        return d;
      };

      async function loadSessions(currentUser) {
        sessionsLoadingEl.classList.remove("hidden");
        sessionsEl.innerHTML = ""; // clear previous render

        // match by tutorName as requested
        const myName = currentUser.displayName || "";
        const qSessions = query(
          collection(db, "Sessions"),
          where("tutorName", "==", myName)
        );
        const sessSnap = await getDocs(qSessions);

        const upcoming = [];
        const today = todayStart();

        sessSnap.forEach((d) => {
          const s = d.data() || {};
          const dateObj = toDate(s.slot?.date);
          if (dateObj && dateObj >= today) {
            upcoming.push({ id: d.id, ...s, _dateObj: dateObj });
          }
        });

        // sort by date, then cycleDay, then block
        upcoming.sort((a, b) => {
          const d = a._dateObj - b._dateObj;
          if (d !== 0) return d;
          const ac = (a.slot?.cycleDay ?? "")
            .toString()
            .localeCompare((b.slot?.cycleDay ?? "").toString());
          if (ac !== 0) return ac;
          return (a.slot?.block ?? "")
            .toString()
            .localeCompare((b.slot?.block ?? "").toString());
        });

        sessionsLoadingEl.classList.add("hidden");

        if (upcoming.length === 0) {
          const none = document.createElement("div");
          none.id = "sessions-empty";
          none.textContent = "No upcoming sessions.";
          sessionsEl.appendChild(none);
        } else {
          upcoming.forEach((s) =>
            sessionsEl.appendChild(
              renderSession(s, { showCancel: true, currentUser })
            )
          );
        }
      }

      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.href = "signup.html";
          return;
        }
        
        // Check for error banner
        try {
          const params = new URLSearchParams(window.location.search);
          if (params.get('err') === 'admin_denied') {
            topBanner.textContent = "You don't have permission to view the admin page.";
            topBanner.classList.remove('hidden');
          }
        } catch (_) {}

        userInfoEl.textContent = `Signed in as ${
          user.displayName || user.email || "Tutor"
        }`;
        userInfoEl.classList.remove("hidden");

        try {
          // --- load tutor profile ---
          const userRef = doc(db, "users", user.uid);
          const userSnap = await getDoc(userRef);
          const profile = userSnap.exists() ? userSnap.data() || {} : {};

          const role = profile.role || null;
          const isHead = role === 'Head';
          const isLead = role && role.endsWith(' Lead');
          if (isLead || isHead) leadConsole.classList.remove('hidden');

          // availability map -> Set of "cycleDay_block"
          const availMap = profile.availability || {};
          const myAvailSet = new Set(
            Object.entries(availMap)
              .filter(([, v]) => !!v)
              .map(([k]) => k.trim())
          );

          // teachable set
          const teachSet = buildTeachSet(profile);

          // ========== UPCOMING SESSIONS ==========
          sessionsLoadingEl.classList.remove("hidden");

          // Query Sessions by tutorName == current user's displayName (as requested)
          const myName = user.displayName || "";
          const qSessions = query(
            collection(db, "Sessions"),
            where("tutorName", "==", myName)
          );
          const sessSnap = await getDocs(qSessions);

          const today = todayStart();
          const upcoming = [];

          sessSnap.forEach((d) => {
            const s = d.data() || {};
            const slot = s.slot || {};
            const dateObj = toDate(slot.date);
            if (!dateObj) return;
            // keep today or future
            if (dateObj >= today) {
              upcoming.push({ id: d.id, ...s, _dateObj: dateObj });
            }
          });

          // Sort ascending by date, then by cycleDay, then by block (string compare)
          upcoming.sort((a, b) => {
            const d = a._dateObj - b._dateObj;
            if (d !== 0) return d;
            const ac = (a.slot?.cycleDay ?? "")
              .toString()
              .localeCompare((b.slot?.cycleDay ?? "").toString());
            if (ac !== 0) return ac;
            return (a.slot?.block ?? "")
              .toString()
              .localeCompare((b.slot?.block ?? "").toString());
          });

          await loadCompletedSessions(user);
          await loadHours(user);

          sessionsLoadingEl.classList.add("hidden");

          if (upcoming.length === 0) {
            const none = document.createElement("div");
            none.id = "sessions-empty";
            none.textContent = "No upcoming sessions.";
            sessionsEl.appendChild(none);
        } else {
          upcoming.forEach((s) =>
            sessionsEl.appendChild(
              renderSession(s, { showCancel: true, showComplete: true, currentUser: user })
            )
          );
        }

          // ========== OPEN REQUESTS ==========
          const snap = await getDocs(collection(db, "Requests"));
          loadingEl.classList.add("hidden");

          if (snap.empty) {
            const none = document.createElement("div");
            none.id = "empty";
            none.textContent = "No open requests.";
            listEl.appendChild(none);
            return;
          }

          let renderedCount = 0;

          snap.forEach((d) => {
            const data = d.data() || {};

            // normalize request slots
            let slots = [];
            if (Array.isArray(data.availability)) {
              slots = data.availability;
            } else if (
              data.availability &&
              typeof data.availability === "object"
            ) {
              slots = Object.values(data.availability);
            }

            // filter by availability match
            const today = todayStart();

            const matchingSlots = slots.filter((s) => {
              const key = slotKey(s);
              const d = toDate(s?.date);
              return key && myAvailSet.has(key) && d && d >= today; // availability AND not in the past
            });

            // filter by teachable class/subject
            const teachOK = isTeachable(data, teachSet);

            // render only if BOTH conditions pass
            if (matchingSlots.length > 0 && teachOK) {
              const banner = renderRequest(d.id, data, user, matchingSlots);
              listEl.appendChild(banner);
              renderedCount++;
            }
          });

          if (renderedCount === 0) {
            const none = document.createElement("div");
            none.id = "empty";
            none.textContent =
              "No open requests that match your availability and classes to teach.";
            listEl.appendChild(none);
          }

          // ========== LEAD / HEAD PANELS ==========
          if (isLead || isHead) {
            // Extract subject from "Math Lead" â†’ "Math"
            const leadSubject = isLead ? role.replace(/\s+Lead$/, '').trim() : null;
            const subjects = isHead ? null : new Set(leadSubject ? [leadSubject] : []);

            // Pending Class Approvals
            leadApprovalsLoadingEl.classList.remove('hidden');
            leadApprovalsEl.innerHTML = '';
            const approvalsSnap = await getDocs(collection(db, 'ClassRequests'));
            const pending = [];
            approvalsSnap.forEach((d) => {
              const r = d.data() || {};
              if (r.status === 'pending' && (isHead || subjects.has(r.subject))) {
                pending.push({ id: d.id, ...r });
              }
            });
            leadApprovalsLoadingEl.classList.add('hidden');
            if (pending.length === 0) {
              const none = document.createElement('div');
              none.textContent = 'No pending class requests.';
              leadApprovalsEl.appendChild(none);
            } else {
              pending.forEach((r) => {
                const row = document.createElement('div');
                row.className = 'request-banner';
                row.innerHTML = `
                  <div class="req-col grow">
                    <h3>${r.userName || r.userEmail || 'Tutor'} <span class="pill">${r.subject}</span> <span class="pill">${r.class}</span></h3>
                    <div class="kv"><span class="k">Email</span><span>${r.userEmail || ''}</span></div>
                    <div class="kv"><span class="k">Requested</span><span>${r.requestedAt || ''}</span></div>
                  </div>
                `;
                const actions = document.createElement('div');
                actions.className = 'right';
                const approve = document.createElement('button');
                approve.className = 'primary';
                approve.textContent = 'Approve';
                const reject = document.createElement('button');
                reject.className = 'ghost';
                reject.textContent = 'Reject';
                actions.appendChild(approve);
                actions.appendChild(reject);
                row.appendChild(actions);

                approve.addEventListener('click', async () => {
                  approve.disabled = true; reject.disabled = true;
                  const ref = doc(db, 'ClassRequests', r.id);
                  await setDoc(ref, { status: 'approved', decidedAt: new Date().toISOString() }, { merge: true });
                  row.remove();
                });
                reject.addEventListener('click', async () => {
                  approve.disabled = true; reject.disabled = true;
                  const ref = doc(db, 'ClassRequests', r.id);
                  await setDoc(ref, { status: 'rejected', decidedAt: new Date().toISOString() }, { merge: true });
                  row.remove();
                });

                leadApprovalsEl.appendChild(row);
              });
            }

            // Open Tutoring Requests in My Subjects
            leadOpenLoadingEl.classList.remove('hidden');
            leadOpenEl.innerHTML = '';
            const reqSnap = await getDocs(collection(db, 'Requests'));
            const openReqs = [];
            reqSnap.forEach((d) => {
              const r = d.data() || {};
              if ((isHead || subjects.has(r.subject)) && r.subject) {
                openReqs.push({ id: d.id, ...r });
              }
            });
            leadOpenLoadingEl.classList.add('hidden');
            if (openReqs.length === 0) {
              const none = document.createElement('div');
              none.textContent = 'No open requests in your subjects.';
              leadOpenEl.appendChild(none);
            } else {
              openReqs.forEach((r) => {
                const row = document.createElement('div');
                row.className = 'request-banner';
                row.innerHTML = `
                  <div class="req-col grow">
                    <h3>${r.name || 'Student'} <span class="pill">${r.subject || 'â€”'}</span> <span class="pill">${r.class || 'â€”'}</span></h3>
                    <div class="kv"><span class="k">Email</span><span>${r.email || ''}</span></div>
                    <div class="kv"><span class="k">Topic</span><span>${r.topic || 'â€”'}</span></div>
                  </div>
                `;
                leadOpenEl.appendChild(row);
              });
            }

            // Completed sessions in my subjects (yesterday or earlier)
            leadCompletedLoadingEl.classList.remove('hidden');
            leadCompletedEl.innerHTML = '';
            const sessAllSnap = await getDocs(collection(db, 'Sessions'));
            const completed = [];
            const today = todayStart();
            sessAllSnap.forEach((d) => {
              const s = d.data() || {};
              const dateObj = toDate(s.slot?.date);
              if (!dateObj || dateObj >= today) return;
              if (isHead || subjects.has(s.subject)) completed.push({ id: d.id, ...s, _dateObj: dateObj });
            });
            completed.sort((a,b)=>a._dateObj-b._dateObj);
            leadCompletedLoadingEl.classList.add('hidden');
            if (completed.length === 0) {
              const none = document.createElement('div');
              none.textContent = 'No completed sessions in your subjects.';
              leadCompletedEl.appendChild(none);
            } else {
              completed.forEach((s) => leadCompletedEl.appendChild(renderSession(s)));
            }
          }
        } catch (e) {
          sessionsLoadingEl.classList.add("hidden");
          loadingEl.textContent = "Failed to load requests.";
          console.error(e);
        }
      });

      // ========== HOURS MANAGEMENT ==========
      const addHourBtn = document.getElementById("addHourBtn");
      const addHourModal = document.getElementById("addHourModal");
      const closeHourModal = document.getElementById("closeHourModal");
      const cancelHourBtn = document.getElementById("cancelHourBtn");
      const submitHourBtn = document.getElementById("submitHourBtn");
      const hourDate = document.getElementById("hourDate");
      const hourCalendarBtn = document.getElementById("hourCalendarBtn");
      const hourCalendarLabel = document.getElementById("hourCalendarLabel");
      const hourDayLabel = document.getElementById("hourDayLabel");
      const hourScheduleWrap = document.getElementById("hourScheduleWrap");
      const hourDescription = document.getElementById("hourDescription");
      const hoursEl = document.getElementById("hours");
      const hoursLoadingEl = document.getElementById("hours-loading");

      let selectedHourCycleDay = "";
      let selectedHourBlock = "";
      let hourXmlCache = null;

      async function fetchHourXml() {
        if (hourXmlCache) return hourXmlCache;
        const url = `https://www.hw.com/portals/0/reports/DailySchedulesUS.xml?t=${Math.random()}`;
        const res = await fetch(url);
        const text = await res.text();
        const xml = new window.DOMParser().parseFromString(text, "text/xml");
        hourXmlCache = xml;
        return xml;
      }

      function toMMDDYYYY(iso) {
        if (typeof iso === "string" && /^\d{4}-\d{2}-\d{2}$/.test(iso)) {
          const [y, m, d] = iso.split("-");
          return m + "/" + d + "/" + y;
        }
        const dt = new Date(iso);
        const mm = String(dt.getMonth() + 1).padStart(2, "0");
        const dd = String(dt.getDate()).padStart(2, "0");
        const yyyy = dt.getFullYear();
        return mm + "/" + dd + "/" + yyyy;
      }

      function twelveHr(hhmm) {
        return hhmm.replace(":00 AM", " AM").replace(":00 PM", " PM");
      }

      function extractTime(raw) {
        return raw.replace("1/1/1900 ", "");
      }

      function buildHourScheduleTable(day) {
        const periods = Array.from(day.getElementsByTagName("Period"));
        if (!periods.length) {
          hourScheduleWrap.innerHTML = '<div style="text-align:center;padding:18px;color:#64748b">No schedule for this day.</div>';
          return;
        }
        const table = document.createElement("table");
        table.style.width = "100%";
        table.style.borderCollapse = "collapse";
        periods.forEach((p) => {
          const code = p.getElementsByTagName("PeriodCode")[0].textContent.trim();
          const start = twelveHr(extractTime(p.getElementsByTagName("StartTime")[0].textContent));
          const end = twelveHr(extractTime(p.getElementsByTagName("EndTime")[0].textContent));
          if (code in blocksCatalog) {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td style="padding:10px 12px;border-bottom:1px solid #f0f2f7;font-weight:700;width:96px">${code}</td><td style="padding:10px 12px;border-bottom:1px solid #f0f2f7;font-size:14px;color:#334155">${start} â€“ ${end}</td><td style="padding:10px 12px;border-bottom:1px solid #f0f2f7;text-align:right"><button class="btn" data-code="${code}" style="border:1px solid #cbd5e1;padding:6px 10px;border-radius:8px;background:#fff;cursor:pointer">Select</button></td>`;
            table.appendChild(tr);
          }
        });
        hourScheduleWrap.innerHTML = "";
        hourScheduleWrap.appendChild(table);
        hourScheduleWrap.querySelectorAll("button[data-code]").forEach((btn) => {
          btn.addEventListener("click", () => {
            selectedHourBlock = btn.getAttribute("data-code");
            hourScheduleWrap.querySelectorAll("button[data-code]").forEach(b => {
              b.textContent = "Select";
              b.disabled = false;
            });
            btn.textContent = "âœ“ Selected";
            btn.disabled = true;
          });
        });
      }

      hourCalendarBtn.addEventListener("click", () => {
        if (typeof hourDate.showPicker === "function") {
          hourDate.showPicker();
        } else {
          hourDate.focus();
          hourDate.click();
        }
      });

      hourDate.addEventListener("change", async () => {
        if (!hourDate.value) return;
        hourCalendarLabel.textContent = toMMDDYYYY(hourDate.value);
        const xml = await fetchHourXml();
        const target = toMMDDYYYY(hourDate.value);
        const days = Array.from(xml.getElementsByTagName("CalendarDay"));
        const match = days.find((d) => (d.getElementsByTagName("Date")[0]?.textContent || "").trim() === target);
        if (!match) {
          hourScheduleWrap.innerHTML = '<div style="text-align:center;padding:18px;color:#64748b">No school schedule found for this date.</div>';
          hourDayLabel.textContent = "";
          selectedHourCycleDay = "";
          return;
        }
        selectedHourCycleDay = (match.getElementsByTagName("CycleDay")[0]?.textContent || "").trim();
        hourDayLabel.textContent = selectedHourCycleDay ? `Day ${selectedHourCycleDay}` : "";
        buildHourScheduleTable(match);
      });

      addHourBtn.addEventListener("click", () => {
        addHourModal.style.display = "flex";
        hourDate.value = "";
        hourCalendarLabel.textContent = "Pick a date";
        hourDayLabel.textContent = "";
        hourDescription.value = "";
        selectedHourCycleDay = "";
        selectedHourBlock = "";
        hourScheduleWrap.innerHTML = '<div style="text-align:center;padding:18px;color:#64748b">Pick a date to load the scheduleâ€¦</div>';
      });

      closeHourModal.addEventListener("click", () => {
        addHourModal.style.display = "none";
      });

      cancelHourBtn.addEventListener("click", () => {
        addHourModal.style.display = "none";
      });

      addHourModal.addEventListener("click", (e) => {
        if (e.target === addHourModal) addHourModal.style.display = "none";
      });

      submitHourBtn.addEventListener("click", async () => {
        if (!hourDate.value) {
          alert("Please select a date");
          return;
        }
        if (!selectedHourBlock) {
          alert("Please select a block");
          return;
        }
        submitHourBtn.disabled = true;
        submitHourBtn.textContent = "Adding...";
        try {
          const currentUser = auth.currentUser;
          await addDoc(collection(db, "Hours"), {
            tutorUid: currentUser.uid,
            tutorName: currentUser.displayName || null,
            tutorEmail: currentUser.email || null,
            date: toMMDDYYYY(hourDate.value),
            cycleDay: selectedHourCycleDay,
            block: selectedHourBlock,
            description: hourDescription.value.trim() || null,
            type: "self_reported",
            createdAt: new Date().toISOString(),
          });
          addHourModal.style.display = "none";
          await loadHours(currentUser);
          alert("Hour added successfully!");
        } catch (err) {
          console.error("Error adding hour:", err);
          alert("Failed to add hour. Please try again.");
        } finally {
          submitHourBtn.disabled = false;
          submitHourBtn.textContent = "Add Hour";
        }
      });

      async function loadHours(currentUser) {
        hoursLoadingEl.classList.remove("hidden");
        hoursEl.innerHTML = "";
        const qHours = query(collection(db, "Hours"), where("tutorUid", "==", currentUser.uid));
        const hoursSnap = await getDocs(qHours);
        const hours = [];
        hoursSnap.forEach((d) => {
          const h = d.data() || {};
          hours.push({ id: d.id, ...h });
        });
        hours.sort((a, b) => {
          const aDate = new Date(a.date || 0);
          const bDate = new Date(b.date || 0);
          if (bDate - aDate !== 0) return bDate - aDate;
          return String(b.cycleDay).localeCompare(String(a.cycleDay));
        });
        hoursLoadingEl.classList.add("hidden");
        if (hours.length === 0) {
          hoursEl.innerHTML = '<div style="padding:16px;text-align:center;color:#9ca3af">No hours recorded yet.</div>';
          return;
        }
        
        const totalHours = hours.length;
        const summary = document.createElement("div");
        summary.style.cssText = "background:#eff6ff;border:1px solid #dbeafe;border-radius:10px;padding:12px 16px;margin-bottom:12px;font-weight:600;color:#1e40af";
        summary.textContent = `Total Hours: ${totalHours}`;
        hoursEl.appendChild(summary);

        hours.forEach((h) => {
          const row = document.createElement("div");
          row.className = "request-banner";
          row.style.marginBottom = "8px";
          const blockName = blocksCatalog[h.block] || h.block;
          const typeLabel = h.type === "self_reported" ? "Self-Reported" : "Completed Session";
          const typePill = h.type === "self_reported" ? 
            '<span class="pill" style="background:#fef3c7;border-color:#fcd34d;color:#92400e">Self-Reported</span>' :
            '<span class="pill" style="background:#d1fae5;border-color:#6ee7b7;color:#065f46">Auto-Tracked</span>';
          row.innerHTML = `
            <div class="req-col grow">
              <div><strong>${h.date || "N/A"}</strong> â€¢ Day ${h.cycleDay || "?"} â€¢ ${blockName} ${typePill}</div>
              ${h.subject ? `<div style="margin-top:4px;font-size:13px;color:#6b7280">${h.subject}${h.class ? ` â€” ${h.class}` : ""}</div>` : ""}
              ${h.description ? `<div style="margin-top:4px;font-size:13px;color:#6b7280">${h.description}</div>` : ""}
              ${h.studentName ? `<div style="margin-top:4px;font-size:13px;color:#6b7280">Student: ${h.studentName}</div>` : ""}
            </div>
          `;
          hoursEl.appendChild(row);
        });
      }

      // Sign out handler (available after app/auth init)
      if (signOutBtn) {
        signOutBtn.addEventListener("click", async () => {
          try {
            await signOut(auth);
          } finally {
            window.location.href = "index.html";
          }
        });
      }
    </script>
  </body>
</html>
