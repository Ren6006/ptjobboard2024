<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Board</title>
  <style>
    #requests-container { display:flex; flex-wrap:wrap; gap:20px; }
    .post-it { width:200px; background:#fdfd96; padding:10px; border:1px solid #ccc; border-radius:8px; box-shadow:2px 2px 6px rgba(0,0,0,0.1); font-family:Arial,sans-serif; }
    .post-it h3 { margin:0 0 5px 0; font-size:18px; font-weight:bold; }
    .post-it p { margin:5px 0; font-size:14px; }
    .post-it strong { font-weight:bold; }

    .my-account-btn {
      position:absolute; top:20px; right:20px; background:#007BFF; color:#fff;
      padding:10px 20px; text-decoration:none; border-radius:4px; font-weight:bold; font-family:Arial,sans-serif;
    }
    .my-account-btn:hover { background:#0056b3; }

    .hidden { display:none; }
  </style>
</head>
<body>
  <a id="accountBtn" href="account.html" class="my-account-btn">MY ACCOUNT</a>

  <div id="loading" class="post-it">Loading…</div>
  <div id="user-info" class="hidden"></div>
  <div id="requests-container" class="hidden"></div>

  <!-- Firebase (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, getDocs, addDoc, deleteDoc, doc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Use the config you used previously (no placeholders)
    const firebaseConfig = {
      apiKey: "AIzaSyDY2gf5I7kJQ7iXD8F6U2BrEMCYjfnFQxk",
      authDomain: "ptjobboard2024.firebaseapp.com",
      databaseURL: "https://ptjobboard2024-default-rtdb.firebaseio.com",
      projectId: "ptjobboard2024",
      storageBucket: "ptjobboard2024.firebasestorage.app",
      messagingSenderId: "401143229772",
      appId: "1:401143229772:web:b5b14d89a89d75443df3e9",
      measurementId: "G-PF9F78SKZV"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    await setPersistence(auth, browserLocalPersistence).catch(()=>{});

    const loading = document.getElementById('loading');
    const userInfoDiv = document.getElementById('user-info');
    const requestsContainer = document.getElementById('requests-container');

    function show(el){ el.classList.remove('hidden'); }
    function hide(el){ el.classList.add('hidden'); }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // Not signed in — send to signup/login flow
        window.location.href = 'signup.html';
        return;
      }

      // Signed in: show greeting and load requests
      userInfoDiv.textContent = `Welcome, ${user.displayName || user.email || 'Tutor'}!`;
      hide(loading);
      show(userInfoDiv);
      show(requestsContainer);

      try {
        const snap = await getDocs(collection(db, "Requests"));
        snap.forEach((d) => {
          const data = d.data();
          const note = document.createElement('div');
          note.className = 'post-it';

          note.innerHTML = `
            <h3>${data.name || "No Name"}</h3>
            <p><strong>Email:</strong> ${data.email || "N/A"}</p>
            <p><strong>Grade:</strong> ${data.grade || "N/A"}</p>
            <p><strong>Subject:</strong> ${data.subject || "N/A"}</p>
            <p><strong>Class:</strong> ${data.class || "N/A"}</p>
            <p><strong>Topic:</strong> ${data.topic || "N/A"}</p>
            <p><strong>Date:</strong> ${data.date || "N/A"}</p>
            <p><strong>Block:</strong> ${data.block || "N/A"}</p>
            <p><strong>Location:</strong> ${data.location || "N/A"}</p>
            <p><strong>Info:</strong> ${data.info || "N/A"}</p>
          `;

          // Accept flow
          const acceptButton = document.createElement('button');
          acceptButton.textContent = 'Accept Request';

          const confirmationContainer = document.createElement('div');
          confirmationContainer.style.display = 'none';

          const confirmButton = document.createElement('button');
          confirmButton.textContent = '✓';
          confirmButton.style.marginRight = '10px';

          const cancelButton = document.createElement('button');
          cancelButton.textContent = 'x';

          confirmationContainer.appendChild(confirmButton);
          confirmationContainer.appendChild(cancelButton);

          acceptButton.addEventListener('click', () => {
            acceptButton.style.display = 'none';
            confirmationContainer.style.display = 'inline-block';
          });

          confirmButton.addEventListener('click', async () => {
            // Guard: ensure still signed in
            const u = auth.currentUser;
            if (!u) { window.location.href = 'signup.html'; return; }

            confirmButton.disabled = true;
            try {
              await addDoc(collection(db, "Sessions"), {
                ...data,
                tutorUid: u.uid,
                tutorEmail: u.email || null,
                tutorName: u.displayName || null,
                acceptedAt: new Date().toISOString()
              });
              await deleteDoc(doc(db, "Requests", d.id));
              note.remove();
            } catch (err) {
              console.error("Error moving request to Sessions:", err);
              confirmButton.disabled = false;
              // restore UI
              confirmationContainer.style.display = 'none';
              acceptButton.style.display = 'inline-block';
            }
          });

          cancelButton.addEventListener('click', () => {
            confirmationContainer.style.display = 'none';
            acceptButton.style.display = 'inline-block';
          });

          note.appendChild(acceptButton);
          note.appendChild(confirmationContainer);
          requestsContainer.appendChild(note);
        });
      } catch (e) {
        console.error("Error getting documents: ", e);
      }
    });
  </script>
</body>
</html>
