<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dynamic Form</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    /* Title styling */
    h1 {
            font-size: 3rem;
            color: #333;
            margin: 0px 0 10px; /* Pushes the title to the top */
            text-align: center;
        }
    body {
      font-family: Arial, sans-serif;
      flex-direction: column;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: #f4f4f9;
    }
    .form-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: #ffffff;
      margin: 0px 30px 30px;
      padding: 40px 30px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .form-container form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    input[type="text"], button {
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 5px;
      width: 500px;
    }
    button {
      background-color: #007BFF;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    .new-field {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 20px;
    }
    .new-field input[type="text"] {
      width: 100%;
    }
    select {
    padding: 10px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 5px;
    width: 300px;
    box-sizing: border-box;
    appearance: none;
    background-color: #f6f4ec;
    color: #000;
    }

    select:focus {
    outline: none;
    border-color: #007BFF;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
    }

    button {
    width: 100%; /* Match input fields' width */
    font-family: Arial, sans-serif; /* Match input fields' font */
    font-size: 16px; /* Match input fields' font size */
    padding: 10px; /* Match input fields' padding */
    border: 1px solid #ccc; /* Match input fields' border */
    border-radius: 4px; /* Match input fields' border radius */
    cursor: pointer; /* Pointer cursor for buttons */
    box-sizing: border-box; /* Prevents padding from affecting width */
    margin-top: 10px; /* Space above the button */
    }

    button:hover {
    background-color: #4254e1; /* Slight hover effect */
    }

    button:active {
    background-color: #d0d0d0; /* Slightly darker on click */
    }

    button:disabled {
    background-color: #f0f0f0; /* Disabled state color */
    cursor: not-allowed; /* Prevent pointer cursor */
    opacity: 0.6; /* Make it look disabled */
    }

    .hidden { display: none; }

  </style>
</head>
<body>
  <!-- Title at the top of the page -->
  <h1>Submit a Tutoring Request!</h1>


  <div class="form-container">
    
    <form id="dynamicForm">
        <input type="text" placeholder="Name (First and Last)" id="name"/>
        <select id="grade">
            <option selected value="" disabled>↓ Select a grade</option>
            <option value=10>10th Grade</option>
            <option value=11>11th Grade</option>
            <option value=12>12th Grade</option>
        </select>
        <select id="subject">
            <option selected value="" disabled>↓ Select a subject</option>
            <option>Math</option>
            <option>Science</option>
            <option>English</option>
            <option>History</option>
            <option>World Language</option>
            <option>Computer Science</option>
            <option>Other</option>
        </select>
        <select id="class">
            <option value="" disabled selected>↓ Select a class (Pick a subject first!)</option>
        </select>
        <input id="topic" type="text" placeholder="Topic (e.g. Factoring, Precipitation, History Research Project, etc.)" />
        <input id="date" type="date" />
        <div id="cycleDayInfo" style="font-size:12px;color:#555;margin-top:4px;"></div>
        <select id="block">
            <option value="" disabled selected>↓ Select a block</option>
        </select>
        <div id="blockAllWrapper" class="hidden">
          <select id="blockAll">
            <option value="" disabled selected>↓ Select any block</option>
          </select>
        </div>
        <input id="location" type="text" placeholder='Location (Leave blank for Learning Center, "Virtual" for Zoom)'/>
        <input id="info" type="text" placeholder="Additional Information"/>
        <button>Submit</button>

    </form>
    </div>
  </div>

  <!-- Add Firebase SDK scripts before your closing </body> tag -->
  <!-- Include Firebase App (the core Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <!-- Include Firebase Firestore -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <!-- Include Firebase Auth -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="common-auth.js"></script>

  <script>


    const firebaseConfig = {

        apiKey: "AIzaSyDY2gf5I7kJQ7iXD8F6U2BrEMCYjfnFQxk",
        authDomain: "ptjobboard2024.firebaseapp.com",
        databaseURL: "https://ptjobboard2024-default-rtdb.firebaseio.com",
        projectId: "ptjobboard2024",
        storageBucket: "ptjobboard2024.firebasestorage.app",
        messagingSenderId: "401143229772",
        appId: "1:401143229772:web:b5b14d89a89d75443df3e9",
        measurementId: "G-PF9F78SKZV"

    };


    // Initialize Firebase (guard against double init due to common-auth.js)
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    var db = firebase.firestore();
    var auth = firebase.auth();
    const subjectChoice = document.getElementById("subject");
    const classChoice = document.getElementById("class");
    const blockSelect = document.getElementById("block");
    const blockAllSelect = document.getElementById("blockAll");
    const blockAllWrapper = document.getElementById("blockAllWrapper");
    const dateInput = document.getElementById('date');
    let userProfile = null;

    const options = {
      math: ["Geometry", "Advanced Geometry", "Honors Geometry", "Algebra II", "Advanced Algebra II", "Honors Algebra II", "Precalculus", "Advanced Precalculus", "Honors Precalculus", "AP Calculus AB", "AP Calculus BC", "Linear Algebra", "Other"],
      science: ["Chemistry", "Honors Chemistry", "AP Chemistry", "Physics I", "Honors Physics I", "AP Physics C: Mechanics", "AP Physics C: Electricity & Magnetism", "AP Environmental Sciences", "Other"],
      history: ["Rise of The Modern World", "ROTW Art History", "Thematic US History", "Honors US History", "Other"],
      english: ["English II", "English III", "Honors English III", "Other"],
      "world language": ["Spanish II", "Honors Spanish II", "Spanish III", "Honors Spanish III", "Spanish IV", "AP Spanish", "French II", "Honors French II", "French III", "Honors French III", "French IV", "Latin II", "Latin III", "Honors Latin III", "Latin IV", "AP Latin", "Chinese II", "Chinese III", "Honors Chinese III", "Chinese IV", "Other"],
      "computer science": ["Advanced Computer Science", "Design and Data Structures"],
      other: ["Other"],
    };


    function rebuildClassOptions(subject){
      classChoice.innerHTML = '<option value="" disabled selected>↓ Select a class</option>';
      if (!subject) { return; }
      const list = options[subject.toLowerCase()] || [];
      const preferred = (userProfile && Array.isArray(userProfile.classes)) ? list.filter(c => userProfile.classes.indexOf(c) !== -1) : [];
      const rest = list.filter(c => preferred.indexOf(c) === -1);
      if (preferred.length > 0) {
        const group = document.createElement('optgroup');
        group.label = 'Your classes';
        preferred.forEach((topic) => {
          const opt = document.createElement('option');
          opt.value = topic; opt.textContent = topic;
          group.appendChild(opt);
        });
        classChoice.appendChild(group);
      }
      rest.forEach((topic) => {
        const opt = document.createElement('option');
        opt.value = topic; opt.textContent = topic;
        classChoice.appendChild(opt);
      });
    }
    

    subjectChoice.addEventListener("change", () => {
      const selectedSubject = subjectChoice.value;
      rebuildClassOptions(selectedSubject);
    });

    const blocksCatalog = [
      { id: 'B1', label: 'Block 1' },
      { id: 'B2', label: 'Block 2' },
      { id: 'B3', label: 'Block 3' },
      { id: 'B4', label: 'Block 4' },
      { id: 'B5', label: 'Block 5' },
      { id: 'B6', label: 'Block 6' },
      { id: 'B7', label: 'Block 7' },
      { id: 'LUNCH', label: 'Lunch' },
      { id: 'DS', label: 'DS/Conference' }
    ];

    function buildAllBlocksSelect() {
      blockAllSelect.innerHTML = '<option value="" disabled selected>↓ Select any block</option>';
      blocksCatalog.forEach((blk) => {
        const opt = document.createElement('option');
        opt.value = blk.label;
        opt.textContent = blk.label;
        blockAllSelect.appendChild(opt);
      });
    }

    function buildUserBlocksSelect(availability) {
      blockSelect.innerHTML = '<option value="" disabled selected>↓ Select a block</option>';
      const available = new Set();
      if (availability && typeof availability === 'object') {
        Object.keys(availability).forEach((k) => {
          if (availability[k]) {
            const parts = k.split('_');
            if (parts.length === 2) { available.add(parts[1]); }
          }
        });
      }
      const idToLabel = blocksCatalog.reduce((acc, b) => { acc[b.id] = b.label; return acc; }, {});
      const labels = [];
      available.forEach((id) => { if (idToLabel[id]) { labels.push(idToLabel[id]); } });
      labels.sort();
      labels.forEach((lbl) => {
        const opt = document.createElement('option');
        opt.value = lbl; opt.textContent = lbl;
        blockSelect.appendChild(opt);
      });
      const otherOpt = document.createElement('option');
      otherOpt.value = '__OTHER__';
      otherOpt.textContent = 'Other…';
      blockSelect.appendChild(otherOpt);
    }

    function buildBlocksForDay(availability, dayNumber) {
      blockSelect.innerHTML = '<option value="" disabled selected>↓ Select a block</option>';
      const labels = [];
      const idToLabel = blocksCatalog.reduce((acc, b) => { acc[b.id] = b.label; return acc; }, {});
      if (availability && typeof availability === 'object' && dayNumber) {
        Object.keys(availability).forEach((k) => {
          if (!availability[k]) return;
          const [dPart, bPart] = k.split('_');
          if (dPart === ('D' + String(dayNumber)) && idToLabel[bPart]) {
            labels.push(idToLabel[bPart]);
          }
        });
      }
      // Fallback: if user has no availability for this day, show all blocks so the user can still choose
      if (labels.length === 0) {
        blocksCatalog.forEach((blk) => { labels.push(blk.label); });
      }
      labels.sort();
      labels.forEach((lbl) => {
        const opt = document.createElement('option');
        opt.value = lbl; opt.textContent = lbl;
        blockSelect.appendChild(opt);
      });
      const otherOpt = document.createElement('option');
      otherOpt.value = '__OTHER__';
      otherOpt.textContent = 'Other…';
      blockSelect.appendChild(otherOpt);
    }

    async function getCycleDayForDate(yyyyMmDd) {
      try {
        const doc = await db.collection('cycleDays').doc(yyyyMmDd).get();
        if (doc.exists) { return doc.data().day; }
      } catch (e) {}
      return null;
    }

    buildAllBlocksSelect();
    blockSelect.addEventListener('change', function(){
      if (blockSelect.value === '__OTHER__') {
        blockAllWrapper.classList.remove('hidden');
      } else {
        blockAllWrapper.classList.add('hidden');
      }
    });

    // Require authentication and prefill name/email
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(() => {});
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'signup.html';
        return;
      }
      // Prefill name from profile doc or auth displayName
      try {
        const userDoc = await db.collection('users').doc(user.uid).get();
        const profile = userDoc.exists ? userDoc.data() : {};
        userProfile = profile;
        const nameInput = document.getElementById('name');
        if (nameInput && !nameInput.value) {
          nameInput.value = (profile && profile.name) ? profile.name : (user.displayName || '');
        }
        const gradeEl = document.getElementById('grade');
        if (gradeEl && profile && profile.grade) {
          gradeEl.value = String(profile.grade);
        }
        // Build block select from user's availability (all blocks until date chosen)
        buildUserBlocksSelect(profile && profile.availability ? profile.availability : {});
        // If a subject already chosen (e.g., browser restore), rebuild classes now
        if (subjectChoice && subjectChoice.value) {
          rebuildClassOptions(subjectChoice.value);
        }
      } catch (e) {}

      // React to date selection by loading the cycle day and filtering blocks
      dateInput.addEventListener('change', async function(){
        const iso = dateInput.value; // YYYY-MM-DD
        if (!iso) return;
        const infoEl = document.getElementById('cycleDayInfo');
        const cycleDay = await getCycleDayForDate(iso);
        if (cycleDay) {
          if (infoEl) { infoEl.textContent = 'Cycle Day ' + cycleDay; }
          buildBlocksForDay(userProfile && userProfile.availability ? userProfile.availability : {}, cycleDay);
        } else {
          if (infoEl) { infoEl.textContent = 'Cycle day not found yet for this date.'; }
          // Fallback to all available blocks if day not found yet
          buildUserBlocksSelect(userProfile && userProfile.availability ? userProfile.availability : {});
        }
      });
    });

    // Add an event listener to the form submission
    document.getElementById("dynamicForm").addEventListener("submit", async function(event) {
        event.preventDefault(); // Prevent default form submission

        // Get form field values
        // Get form field values
        const name = document.getElementById("name").value.trim();
        const user = auth.currentUser;
        const email = user ? user.email : '';
        const grade = document.getElementById("grade").value;
        const subject = document.getElementById("subject").value;
        const classSelection = document.getElementById("class").value;
        const topic = document.getElementById("topic").value.trim();
        const dateIso = document.getElementById("date").value.trim();
        const blockValue = (blockSelect.value === '__OTHER__') ? blockAllSelect.value : blockSelect.value;
        let location = document.getElementById("location").value.trim();
        if (!location){
            location = "Learning Center";
        }
        const info = document.getElementById("info").value.trim();

        // Initialize an array to collect error messages
        let errors = [];

        // 1) Check school email via authenticated user
        if (!email || !email.endsWith("@hwemail.com")) {
          errors.push("Please sign in with your @hwemail.com email.");
        }

        // 2) Check if grade, subject, and class have been selected
        if (!grade) {
        errors.push("Please select a grade.");
        }
        if (!subject) {
          errors.push("Please select a subject.");
        }
        if (!classSelection) {
        errors.push("Please select a class.");
        }

        // 3) Date must be chosen from picker
        if (!dateIso) {
          errors.push("Please pick a date.");
        }

        if (!blockValue) {
          errors.push("Please select a block.");
        }

        // If there are errors, display them and prevent submission
        if (errors.length > 0) {
        alert(errors.join("\n"));
        } else {
            // Convert YYYY-MM-DD to MM/DD/YYYY for storage
            const date = dateIso ? (function(){ const [yy,mm,dd] = dateIso.split('-'); return `${mm}/${dd}/${yy}`; })() : '';
            // Get cycle day (if available) for the selected date
            let cycleDay = null;
            try {
              if (dateIso) {
                const snap = await db.collection('cycleDays').doc(dateIso).get();
                if (snap.exists) { cycleDay = snap.data().day || null; }
              }
            } catch (e) {}

            db.collection("Requests").add({
          name: name,
          email: email,
          student_id: auth.currentUser ? auth.currentUser.uid : null,
          grade: grade,
          subject: subject,
          class: classSelection,
          topic: topic,
          date: date,
          block: blockValue,
          cycleDay: cycleDay,
          location: location,
          info: info,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(function(docRef) {
          alert("Request submitted successfully!");
        })
        .catch(function(error) {
          console.error("Error adding document: ", error);
          alert("An error occurred while submitting your request. Please try again.");
        });
        }
    });
  </script>

</body>
</html>
