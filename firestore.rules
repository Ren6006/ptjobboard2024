rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function userDoc(uid) {
      return get(/databases/$(database)/documents/users/$(uid));
    }

    function myRole() {
      return userDoc(request.auth.uid).data.role;
    }

    function isSelf(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    function isAdminTier() {
      return isSignedIn() && (myRole() in ['Admin', 'Head', 'Developer']);
    }

    function isHeadOrAdmin() {
      return isSignedIn() && (myRole() in ['Admin', 'Head']);
    }

    function isLeadForSubject(subject) {
      return isSignedIn() && (myRole() == subject + ' Lead');
    }

    // Avoid recursive get() when reading own user doc
    function isCurrentUserAdmin(uid) {
      return isSignedIn() && (
        (uid == request.auth.uid && (resource.data.role in ['Admin','Head','Developer'])) ||
        (uid != request.auth.uid && (userDoc(request.auth.uid).data.role in ['Admin','Head','Developer']))
      );
    }

    // users documents
    match /users/{uid} {
      allow read: if isSelf(uid) || isCurrentUserAdmin(uid);

      // Owners can update their profile basics only; classes and role are restricted
      allow create: if isSelf(uid);
      allow update: if isSelf(uid)
        && request.resource.data.role == resource.data.role
        && request.resource.data.classes == resource.data.classes;

      // Elevated can write (e.g., admins/tools)
      allow write: if isHeadOrAdmin();
    }

    // Tutor class approval requests
    match /ClassRequests/{requestId} {
      allow read: if isSignedIn() && (
        resource.data.uid == request.auth.uid ||
        isHeadOrAdmin() ||
        isLeadForSubject(resource.data.subject)
      );

      // Create by owner only; uid is immutable after create
      allow create: if isSignedIn()
        && request.resource.data.uid == request.auth.uid;

      // Status moderation by head/admin or subject lead for that subject
      allow update: if isSignedIn() && (
        isHeadOrAdmin() ||
        isLeadForSubject(resource.data.subject)
      );

      // Prevent deletes by non-admins
      allow delete: if isHeadOrAdmin();
    }

    // Student Requests and Sessions (baseline: authenticated read, guarded writes)
    match /Requests/{docId} {
      allow read: if isSignedIn();
      // Allow create/update/delete by any signed-in user (tutors finalize/cancel flows)
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    match /Sessions/{sessionId} {
      allow read: if isSignedIn();
      // Allow create/update/delete by signed-in (tutor finalize/cancel flows)
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    // Fallback block nothing else
    match /{document=**} {
      allow read: if false;
      allow write: if false;
    }
  }
}